<h4reco>
outNameSuffix ntuples/spikes_
path2data /eos/cms/store/group/dpg_ecal/comm_ecal/upgrade/testbeam/ECALTB_H2_Sept2018/data/raw/DataTree/
pluginList DigiReco WFReco 
#this is needed
pluginList+= T2F DFTTmpl WFRecoFFT
run 12314
maxEvents -1
maxFiles -1
</h4reco>

#--Hodoscope
<H4Hodo>
pluginType HodoReco
</H4Hodo>

#---VFEs for bare APDs
VFEs B1 B2 B3 B4 B5

digitizer VFE_CLK MCP1 TRG 

#---VFE config
<DigiReco>
pluginType DigitizerReco
channelsNames= VFEs
channelsNames+= digitizer
</DigiReco>

#---WF reconstruction for VFEs
<WFReco>
pluginType WFAnalyzer
srcInstanceName DigiReco
channelsNames= DigiReco.channelsNames 
timeRecoTypes CFD 

fillWFtree 1
WFtreePrescale 1
</WFReco>

#---Spike finder
<SpikeTagger>
pluginType SpikeTagger
srcInstanceName DigiReco
channelsNames= VFEs
undershootFinderWindow 10
weightsLd 1.48322 -2.20018 1.89766 -0.683441

fillWFtree 1
WFtreePrescale 1
storeNSampleBeforeMax 10
storeNSampleAfterMax 10
</SpikeTagger>


#---Channels

<C5>
digiBoard 4
digiGroup 0
digiChannel 0
polarity 1
nSamples 100
tUnit    6.25
baselineWin 1 10
baselineInt 15 25
signalWin 30 105 5 gaus
signalInt 2 3
LED 100 1 3
#---Template building options
#---Oversampling frequency (GHz)
fOversampling 8
#---Butterworth filter options                                                                                                                      
<BWFilter>
order 4
wCut 0.08
</BWFilter>
</C5>

<C4= C5>
digiChannel 1
</C4>

<C3= C5>
digiChannel 2
</C3>

<C2= C5>
digiChannel 3
</C2>

<C1= C5>
digiChannel 4
</C1>

<D1= C5>
digiBoard 5
digiChannel 0
</D1>

<D2= D1>
digiChannel 1
</D2>

<D3= D1>
digiChannel 2
</D3>

<D4= D1>
digiChannel 3
</D4>

<D5= D1>
digiChannel 4
</D5>

<B1= C5>
digiBoard 3
digiChannel 0
</B1>

<B2= B1>
digiChannel 1
</B2>

<B3= B1>
digiChannel 2
</B3>

<B4= B1>
digiChannel 3
</B4>

<B5= B1>
digiChannel 4
</B5>

#---A column
<A1= C5>
digiBoard 3
digiChannel 4
</A1>

<A2= A1>
digiChannel 3
</A2>

<A3= A1>
digiChannel 2
</A3>

<A4= A1>
digiChannel 1
</A4>

<A5= A1>
digiChannel 0
</A5>

#---E column
<E1= C5>
digiBoard 7
digiChannel 4
</E1>

<E2= E1>
digiChannel 3
</E2>

<E3= E1>
digiChannel 2
</E3>

<E4= E1>
digiChannel 1
</E4>

<E5= E1>
digiChannel 0
</E5>

<MCP1>
subtractChannel void
digiBoard 50462721
digiGroup 0
digiChannel 1
polarity -1
nSamples 1024
tUnit 0.2
baselineWin 1 50
baselineInt 30 50
signalWin 50 1000 7 gaus
signalInt 10 10
CFD 0.5 5
</MCP1>

<MCP2= MCP1>
digiChannel 2
</MCP2>

<VFE_CLK= MCP1>
digiChannel 2
type Clock
CFD
CLK -1.3 1.3
LED 0 2 2 200 300
</VFE_CLK>

<void= MCP1>
subtractChannel 
digiChannel 7
</void>

<TRG= MCP1>
digiChannel 8
LED 400 1 3
</TRG>

#---Oversampled pulse shape reconstruction
<WFRecoFFT= WFReco>
srcInstanceName DFTTmpl
channelsNames B2_T
digiTreeName digi_t
wfTreeName wf_t
fillWFtree 0
WFtreePrescale 1
</WFRecoFFT>

#---T2F
<T2F>
pluginType FFTAnalyzer
srcInstanceName DigiReco
normalizeInput 0
makeTemplates Re Im Ampl Phase
channelsNames B2
storeTree 1
</T2F>

#---Make template by artificially oversampling original signal (fOversampling is expressed in GHz)
<DFTTmpl>
pluginType DFTTemplate
srcInstanceName T2F
outWFSuffix _T
channelsNames B2
</DFTTmpl>

#---This values must be tuned manually depending on C5.signalWin:
#   this beacause DFTTemplate only uses samples between C5.signalWin[0] and C3.signalWin[1],
#   so the baseline samples and signal samples fall in a different region which are not directly related to
#   those of the original WF
<C5_T= C5>
baselineWin 25 250
baselineInt 250 500
signalWin 500 2500 250 gaus #what are these numbers
signalInt 200 600
CFD 0.5 10 10
</C5_T>

<C4_T= C5_T>
digiChannel 1
</C4_T>

<C3_T= C5_T>
digiChannel 2
</C3_T>

<C2_T= C5_T>
digiChannel 3
</C2_T>

<C1_T= C5_T>
digiChannel 4
</C1_T>

#---D column
<D1_T= C5_T>
digiBoard 7
digiChannel 0
</D1_T>

<D2_T= D1_T>
digiChannel 1
</D2_T>

<D3_T= D1_T>
digiChannel 2
</D3_T>

<D4_T= D1_T>
digiChannel 3
</D4_T>

<D5_T= D1_T>
digiChannel 4
</D5_T>

#---B column
<B1_T= C5_T>
digiBoard 3
digiChannel 0
</B1_T>

<B2_T= B1_T>
digiChannel 1
</B2_T>

<B3_T= B1_T>
digiChannel 2
</B3_T>

<B4_T= B1_T>
digiChannel 3
</B4_T>

<B5_T= B1_T>
digiChannel 4
</B5_T>

#---A column                                                                                                                                           
<A1_T= C5_T>
digiBoard 4
digiChannel 0
</A1_T>

<A2_T= A1_T>
digiChannel 3
</A2_T>

<A3_T= A1_T>
digiChannel 2
</A3_T>

#---E column                                                                                                                                           
<E1_T= C5_T>
digiBoard 1
digiChannel 4
</E1_T>

<E2_T= E1_T>
digiChannel 3
</E2_T>

<E3_T= E1_T>
digiChannel 2
</E3_T>

